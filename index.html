<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Letter That Reveals Itself</title>
  <style>
    :root{
      --bg: #0f1724;
      --accent: #ff6b6b;
      --muted: rgba(255,255,255,0.65);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;display:flex;align-items:center;justify-content:center;}
    .wrap{width:min(820px,94%);padding:28px;border-radius:16px;background:rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    .paper{min-height:320px;padding:48px 40px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:crosshair;}
    .line{opacity:0;transform:translateY(10px);transition:opacity 600ms,transform 600ms;font-size:20px;line-height:1.45;margin:10px 0;}
    .line.visible{opacity:1;transform:translateY(0);}
    .controls{display:flex;align-items:center;gap:12px;margin-top:18px;}
    .btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;cursor:pointer;color:var(--muted);font-weight:600;}
    .btn.primary{background:linear-gradient(90deg,rgba(255,107,107,0.15),rgba(255,165,85,0.06));color:white;border:1px solid rgba(255,107,107,0.18);}
    .final-message{margin-top:18px;font-size:18px;color:#ffdfe0;display:none;}
    .final-message.visible{display:flex;}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="paper" class="paper" tabindex="0"></div>
    <div class="controls">
      <button id="replay" class="btn">Restart</button>
      <button id="smileBtn" class="btn primary" style="display:none">Press this if you smiled</button>
      <div id="final" class="final-message"><span id="finalText"></span></div>
    </div>
  </div>
  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:9999;display:none"></canvas>
  <script>
    const paper = document.getElementById('paper');
    const smileBtn = document.getElementById('smileBtn');
    const finalText = document.getElementById('finalText');
    const final = document.getElementById('final');
    const replay = document.getElementById('replay');

    async function fetchLetter() {
      try {
        const resp = await fetch('/api/generate-letter', { method: 'POST' });
        if (!resp.ok) throw new Error('Failed to fetch letter');
        const json = await resp.json();
        return json.lines || [];
      } catch (err) {
        console.error('Fetch letter error', err);
        return [
          "Hey love,",
          "Even now, thinking of you makes the whole day feel softer.",
          "You turn my little moments into something I'll remember forever.",
          "If feelings could be code, you'd be my favorite function.",
          "I love you more simply than words can hold.",
          "Press the button if this made you smile — I promise a little celebration on my end. ❤️"
        ];
      }
    }

    async function init() {
      const LINES = await fetchLetter();
      paper.innerHTML = '';
      LINES.forEach((t, i) => {
        const p = document.createElement('div');
        p.className = 'line';
        p.dataset.index = i;
        p.textContent = t;
        paper.appendChild(p);
      });
      setupReveal();
    }

    function setupReveal() {
      const lines = Array.from(document.querySelectorAll('.line'));
      let revealIndex = 0;
      let revealTimer = null;
      let fast = false;

      function revealNext() {
        if (revealIndex >= lines.length) return;
        const el = lines[revealIndex];
        el.classList.add('visible');
        revealIndex++;
        if (revealIndex >= lines.length) smileBtn.style.display = 'inline-block';
      }

      function startAutoReveal() {
        if (revealTimer) return;
        revealTimer = setInterval(() => {
          revealNext();
          if (revealIndex >= lines.length) clearInterval(revealTimer);
        }, fast ? 200 : 900);
      }

      function stopAutoReveal() { if (revealTimer) { clearInterval(revealTimer); revealTimer = null; } }

      paper.addEventListener('click', () => {
        fast = true;
        for (let i = 0; i < 3; i++) revealNext();
        stopAutoReveal();
        startAutoReveal();
      });

      paper.addEventListener('pointerenter', () => { startAutoReveal(); });
      paper.addEventListener('pointerleave', () => { stopAutoReveal(); fast = false; });

      smileBtn.addEventListener('click', () => {
        smileBtn.disabled = true;
        smileBtn.textContent = 'Sending smiles...';
        runConfetti();
        setTimeout(() => {
          finalText.textContent = 'Then my mission\'s complete ❤️';
          final.classList.add('visible');
          smileBtn.style.display = 'none';
        }, 1200);
      });

      replay.addEventListener('click', () => {
        lines.forEach(l => l.classList.remove('visible'));
        revealIndex = 0;
        smileBtn.style.display = 'none';
        final.classList.remove('visible');
        stopAutoReveal();
        init();
      });
    }

    function runConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      canvas.style.display = 'block';
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = [ [255,107,107], [255,205,86], [86,188,255], [178,102,255], [255,132,180] ];

      function rand(min,max){ return Math.random()*(max-min)+min }

      for(let i=0;i<120;i++){
        particles.push({x:rand(0,canvas.width),y:rand(-canvas.height,0),vx:rand(-2,2),vy:rand(2,7),size:Math.floor(rand(6,12)),color:colors[Math.floor(rand(0,colors.length))],rot:rand(0,Math.PI*2),vr:rand(-0.12,0.12),ttl:rand(2000,3800),born:Date.now()});
      }

      let raf;
      function frame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const now=Date.now();
        particles.forEach(p=>{
          const age=now-p.born;
          if(age>p.ttl)return;
          p.x+=p.vx;p.y+=p.vy;p.vy+=0.06;p.rot+=p.vr;
          ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
          ctx.fillStyle=`rgba(${p.color[0]},${p.color[1]},${p.color[2]},1)`;
          ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6);ctx.restore();
        });
        raf=requestAnimationFrame(frame);
      }
      frame();

      setTimeout(()=>{cancelAnimationFrame(raf);ctx.clearRect(0,0,canvas.width,canvas.height);canvas.style.display='none';},4200);
    }

    window.addEventListener('resize', ()=>{
      const canvas=document.getElementById('confettiCanvas');
      canvas.width=window.innerWidth;canvas.height=window.innerHeight;
    });

    init();
  </script>
</body>
</html>
